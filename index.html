<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="theme-color" content="#4CAF50" />
  <link rel="manifest" href="manifest.json" />
  <title>Softwash Mix Calculator</title>
  <style>
    body {
  font-family: sans-serif;
  margin: 0;
  padding: 1rem;
  background: #f9f9f9;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  height: 100vh;
}

h1, h2 {
  text-align: center;
  color: #333;
}

label {
  font-weight: bold;
  display: block;
  margin-top: 1rem;
}

input, button {
  width: 100%;
  padding: 8px;
  margin-top: 4px;
  box-sizing: border-box;
}

button {
  margin-top: 1.5rem;
  font-size: 16px;
}

#adjust-section {
  display: none;
  margin-top: 1rem;
  padding: 10px;
  background: #eef;
  border-radius: 8px;
}

.output, .log {
  margin-top: 2rem;
  padding: 1rem;
  background: #d4f4d4;
  border-radius: 8px;
  font-weight: bold;
  white-space: pre-wrap;
}

nav {
  text-align: center;
  margin-bottom: 1rem;
}

nav button {
  margin: 0 0.5rem;
}

/* Media queries for responsiveness */
@media (max-width: 600px) {
  body {
    padding: 0.5rem;
  }

  h1, h2 {
    font-size: 1.5rem;
  }

  input, button {
    padding: 10px;
    font-size: 14px;
  }

  .output, .log {
    font-size: 14px;
  }

  #adjust-section {
    padding: 8px;
  }
}

@media (max-width: 400px) {
  h1, h2 {
    font-size: 1.25rem;
  }

  input, button {
    padding: 12px;
    font-size: 16px;
  }

  .output, .log {
    font-size: 12px;
  }
}

  </style>
</head>
<body>
  <nav>
    <button onclick="showPage('calc')">Calculator</button>
    <button onclick="showPage('log')">Log</button>
  </nav>

  <div id="calcPage">
    <h1>Softwash Mix Calculator</h1>

    <label>Tank size (L):</label>
    <input type="number" id="tankSize" placeholder="e.g. 100" />

    <label>Target mix strength (%):</label>
    <input type="number" step="0.1" id="targetMix" placeholder="e.g. 3.5" />

    <label>SH drum strength (%):</label>
    <input type="number" step="0.1" id="shStrength" value="12.5" />

    <label>Surfactant ratio (e.g. 1:75):</label>
    <input type="text" id="surfactantRatio" placeholder="e.g. 1:75" />

    <label>Scent ratio (e.g. 1:100):</label>
    <input type="text" id="scentRatio" placeholder="e.g. 1:100" />

    <label>
      <input type="checkbox" id="adjustToggle" />
      Adjust existing mix?
    </label>

    <div id="adjust-section">
      <label>Current volume in tank (L):</label>
      <input type="number" id="currentVolume" />

      <label>Current mix strength (%):</label>
      <input type="number" step="0.1" id="currentStrength" />
    </div>

    <button onclick="calculateMix()">Calculate Mix</button>

    <div class="output" id="resultOutput"></div>
    <button onclick="promptSaveLog()">Save to Log</button>
  </div>

  <div id="logPage" style="display:none;">
    <h2>Saved Logs</h2>
    <div class="log" id="logOutput"></div>
    <button onclick="clearLog()">Clear Log</button>
  </div>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }

    const adjustToggle = document.getElementById('adjustToggle');
    const adjustSection = document.getElementById('adjust-section');

    adjustToggle.addEventListener('change', () => {
      adjustSection.style.display = adjustToggle.checked ? 'block' : 'none';
    });

    function showPage(page) {
      document.getElementById('calcPage').style.display = page === 'calc' ? 'block' : 'none';
      document.getElementById('logPage').style.display = page === 'log' ? 'block' : 'none';
      if (page === 'log') displayLog();
    }

    function parseRatio(input) {
      if (!input) return 0;
      const parts = input.split(':');
      if (parts.length !== 2) return null;
      const numerator = parseFloat(parts[0]);
      const denominator = parseFloat(parts[1]);
      if (isNaN(numerator) || isNaN(denominator) || denominator === 0) return null;
      return numerator / denominator;
    }

    let lastResult = "";

    function calculateMix() {
      const tankSize = parseFloat(document.getElementById('tankSize').value);
      const targetMix = parseFloat(document.getElementById('targetMix').value);
      const shStrength = parseFloat(document.getElementById('shStrength').value || "12.5");
      const surfRatioInput = document.getElementById('surfactantRatio').value;
      const scentRatioInput = document.getElementById('scentRatio').value;
      const resultDiv = document.getElementById('resultOutput');

      const surfRatio = parseRatio(surfRatioInput);
      const scentRatio = scentRatioInput ? parseRatio(scentRatioInput) : 0;

      if (surfRatio === null) {
        resultDiv.innerText = "‚ö†Ô∏è Invalid surfactant ratio. Use format like 1:75.";
        return;
      }

      if (scentRatioInput && scentRatio === null) {
        resultDiv.innerText = "‚ö†Ô∏è Invalid scent ratio. Use format like 1:100.";
        return;
      }

      if (adjustToggle.checked) {
        const V1 = parseFloat(document.getElementById('currentVolume').value);
        const C1 = parseFloat(document.getElementById('currentStrength').value);
        const Ct = targetMix;
        const C2 = shStrength;
        const Vtotal = tankSize;

        if (Ct >= C2 || isNaN(V1) || isNaN(C1) || isNaN(Vtotal)) {
          resultDiv.innerText = "‚ö†Ô∏è Invalid adjustment input. Ensure target % < SH drum %, and all values are filled.";
          return;
        }

        const V2 = Vtotal - V1;

        const SH_total = (Ct / 100) * Vtotal;
        const SH_existing = (C1 / 100) * V1;
        const SH_needed = SH_total - SH_existing;

        const shToAdd = SH_needed / (C2 / 100);
        const waterToAdd = V2 - shToAdd;
        const surfToAdd = V2 * surfRatio * 1000;
        const scentToAdd = V2 * scentRatio * 1000;

        lastResult = `üîÑ Add to existing tank:\n‚Ä¢ SH (from ${C2}% drum): ${shToAdd.toFixed(2)} L\n‚Ä¢ Water: ${waterToAdd.toFixed(2)} L\n‚Ä¢ Surfactant: ${surfToAdd.toFixed(0)} mL` + (scentRatio > 0 ? `\n‚Ä¢ Scent: ${scentToAdd.toFixed(0)} mL` : '') + `\nüì¶ Final volume: ${Vtotal.toFixed(1)} L at ${Ct.toFixed(1)}%`;
      } else {
        const shRequired = (targetMix / shStrength) * tankSize;
        const waterRequired = tankSize - shRequired;
        const surfactantRequired = tankSize * surfRatio * 1000;
        const scentRequired = tankSize * scentRatio * 1000;

        lastResult = `üß™ Full Batch:\n‚Ä¢ SH (from ${shStrength}% drum): ${shRequired.toFixed(2)} L\n‚Ä¢ Water: ${waterRequired.toFixed(2)} L\n‚Ä¢ Surfactant: ${surfactantRequired.toFixed(0)} mL` + (scentRatio > 0 ? `\n‚Ä¢ Scent: ${scentRequired.toFixed(0)} mL` : '');
      }

      resultDiv.innerText = lastResult;
    }

    function promptSaveLog() {
      if (!lastResult) return;
      const name = prompt("Enter client name (optional):") || "[No Name]";
      const address = prompt("Enter address (optional):") || "[No Address]";
      saveLog(name, address);
    }

    function saveLog(name, address) {
      const logs = JSON.parse(localStorage.getItem('softwashLogs') || '[]');
      const timestamp = new Date().toLocaleString();
      logs.unshift(`[${timestamp}]\nClient: ${name}\nAddress: ${address}\n${lastResult}`);
      localStorage.setItem('softwashLogs', JSON.stringify(logs));
      alert("Saved to log");
    }

    function displayLog() {
      const logs = JSON.parse(localStorage.getItem('softwashLogs') || '[]');
      document.getElementById('logOutput').innerText = logs.join('\n\n');
    }

    function clearLog() {
      if (confirm("Clear all logs?")) {
        localStorage.removeItem('softwashLogs');
        displayLog();
      }
    }
  </script>
</body>
</html>
