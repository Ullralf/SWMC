<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="theme-color" content="#4CAF50" />
  <link rel="manifest" href="manifest.json" />
  <title>Softwash Mix Calculator</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 500px;
      margin: auto;
      padding: 1rem;
      background: #f0f0f0; /* Light Grey Background */
    }
    h1, h2 {
      text-align: center;
      color: #333;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 1rem;
    }
    input {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
    }
    button {
      margin-top: 1.5rem;
      width: 100%;
      padding: 10px;
      font-size: 16px;
    }
    #adjust-section {
      display: none;
      margin-top: 1rem;
      padding: 10px;
      background: #eef;
      border-radius: 8px;
    }
    .output, .log, .cost {
      margin-top: 2rem;
      padding: 1rem;
      background: #d4f4d4;
      border-radius: 8px;
      font-weight: bold;
      white-space: pre-wrap;
    }
    .cost {
      background: #fff3e0; /* Light orange background for cost */
    }
    nav {
      text-align: center;
      margin-bottom: 1rem;
      display: flex;
      justify-content: space-around; /* Distribute buttons evenly across the top */
      gap: 10px;
    }
    nav button {
      padding: 10px 15px;
      font-size: 16px;
      flex: 1; /* Make buttons stretch evenly */
    }
    .settings-btn {
      position: fixed;
      top: 10px;
      right: 10px;
      font-size: 24px;
      background: none;
      border: none;
      cursor: pointer;
    }
    .settings-page {
      display: none;
      padding: 1rem;
      background: #fff;
      border-radius: 8px;
      max-width: 400px;
      margin: auto;
    }
    .save-btn {
      display: none; /* Hidden by default */
    }
  </style>
</head>
<body>
  <!-- Gear icon for settings -->
  <button class="settings-btn" onclick="showSettingsPage()">‚öôÔ∏è</button>

  <nav>
    <button onclick="showPage('calc')">Calculator</button>
    <button onclick="showPage('log')">Log</button>
    <button onclick="showPage('cost')">Cost Calculator</button>
    <button onclick="showSettingsPage()">Settings</button>
  </nav>

  <!-- Settings Page -->
  <div id="settingsPage" class="settings-page">
    <h2>Settings</h2>
    <label for="shDrumSize">Drum Size (L):</label>
    <input type="number" id="shDrumSize" value="200" />
    
    <label for="shDrumPrice">Price per Drum ($):</label>
    <input type="number" id="shDrumPrice" value="120" />

    <button onclick="saveSettings()">Save Settings</button>
    <button onclick="closeSettingsPage()">Close</button>
  </div>

  <!-- Calculator Page -->
  <div id="calcPage">
    <h1>Softwash Mix Calculator</h1>

    <label>Tank size (L):</label>
    <input type="number" id="tankSize" placeholder="e.g. 100" />

    <label>Target mix strength (%):</label>
    <input type="number" step="0.1" id="targetMix" placeholder="e.g. 3.5" />

    <label>SH drum strength (%):</label>
    <input type="number" step="0.1" id="shStrength" value="12.5" />

    <label>Surfactant ratio (e.g. 1:75):</label>
    <input type="text" id="surfactantRatio" placeholder="e.g. 1:75" />

    <label>Scent ratio (e.g. 1:100):</label>
    <input type="text" id="scentRatio" placeholder="e.g. 1:100" />

    <label>
      <input type="checkbox" id="adjustToggle" />
      Adjust existing mix?
    </label>

    <div id="adjust-section">
      <label>Current volume in tank (L):</label>
      <input type="number" id="currentVolume" />

      <label>Current mix strength (%):</label>
      <input type="number" step="0.1" id="currentStrength" />
    </div>

    <button onclick="calculateMix()">Calculate Mix</button>

    <div class="output" id="resultOutput"></div>

    <button class="save-btn" id="saveLogBtn" onclick="promptSaveLog()">Save to Log</button>
  </div>

  <!-- Log Page -->
  <div id="logPage" style="display:none;">
    <h2>Saved Logs</h2>
    <div class="log" id="logOutput"></div>
    <button onclick="clearLog()">Clear Log</button>
  </div>

  <!-- Cost Calculator Page -->
  <div id="costPage" style="display:none;">
    <h1>Cost Calculator</h1>
    
    <label for="costPerL">Cost per liter of SH (e.g., 5):</label>
    <input type="number" step="0.1" id="costPerL" placeholder="e.g. 5" />
    
    <button onclick="calculateCost()">Calculate Cost</button>

    <div class="cost" id="costResult">
      <!-- Result of cost calculation will be displayed here -->
    </div>

    <button onclick="saveCostToLog()">Save Cost to Log</button>
  </div>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }

    const adjustToggle = document.getElementById('adjustToggle');
    const adjustSection = document.getElementById('adjust-section');

    adjustToggle.addEventListener('change', () => {
      adjustSection.style.display = adjustToggle.checked ? 'block' : 'none';
    });

    function showPage(page) {
      document.getElementById('calcPage').style.display = page === 'calc' ? 'block' : 'none';
      document.getElementById('logPage').style.display = page === 'log' ? 'block' : 'none';
      document.getElementById('costPage').style.display = page === 'cost' ? 'block' : 'none'; // Show the cost calculator page

      if (page === 'log') displayLog();
    }

    function showSettingsPage() {
      document.getElementById('settingsPage').style.display = 'block';
    }

    function closeSettingsPage() {
      document.getElementById('settingsPage').style.display = 'none';
    }

    function saveSettings() {
      const shDrumSize = document.getElementById('shDrumSize').value;
      const shDrumPrice = document.getElementById('shDrumPrice').value;

      localStorage.setItem('shDrumSize', shDrumSize);
      localStorage.setItem('shDrumPrice', shDrumPrice);

      alert('Settings saved');
      closeSettingsPage();
    }

    function parseRatio(input) {
      if (!input) return 0;
      const parts = input.split(':');
      if (parts.length !== 2) return null;
      const numerator = parseFloat(parts[0]);
      const denominator = parseFloat(parts[1]);
      if (isNaN(numerator) || isNaN(denominator) || denominator === 0) return null;
      return numerator / denominator;
    }

    let lastResult = "";

    function calculateMix() {
      const tankSize = parseFloat(document.getElementById('tankSize').value);
      const targetMix = parseFloat(document.getElementById('targetMix').value);
      const shStrength = parseFloat(document.getElementById('shStrength').value || "12.5");
      const surfRatioInput = document.getElementById('surfactantRatio').value;
      const scentRatioInput = document.getElementById('scentRatio').value;
      const resultDiv = document.getElementById('resultOutput');
      const saveLogBtn = document.getElementById('saveLogBtn');

      const surfRatio = parseRatio(surfRatioInput);
      const scentRatio = scentRatioInput ? parseRatio(scentRatioInput) : 0;

      if (surfRatio === null) {
        resultDiv.innerText = "‚ö†Ô∏è Invalid surfactant ratio. Use format like 1:75.";
        return;
      }

      if (scentRatioInput && scentRatio === null) {
        resultDiv.innerText = "‚ö†Ô∏è Invalid scent ratio. Use format like 1:100.";
        return;
      }

      if (adjustToggle.checked) {
        const V1 = parseFloat(document.getElementById('currentVolume').value);
        const C1 = parseFloat(document.getElementById('currentStrength').value);
        const Ct = targetMix;
        const C2 = shStrength;
        const Vtotal = tankSize;

        if (Ct >= C2 || isNaN(V1) || isNaN(C1) || isNaN(Vtotal)) {
          resultDiv.innerText = "‚ö†Ô∏è Invalid adjustment input. Ensure target % < SH drum %, and all values are filled.";
          return;
        }

        const V2 = Vtotal - V1;

        const SH_total = (Ct / 100) * Vtotal;
        const SH_existing = (C1 / 100) * V1;
        const SH_needed = SH_total - SH_existing;

        const shToAdd = SH_needed / (C2 / 100);
        const waterToAdd = V2 - shToAdd;
        const surfToAdd = V2 * surfRatio * 1000;
        const scentToAdd = V2 * scentRatio * 1000;

        lastResult = `üîÑ Add to existing tank:\n‚Ä¢ SH (from ${C2}% drum): ${shToAdd.toFixed(2)} L\n‚Ä¢ Water: ${waterToAdd.toFixed(2)} L\n‚Ä¢ Surfactant: ${surfToAdd.toFixed(0)} mL` + (scentRatio > 0 ? `\n‚Ä¢ Scent: ${scentToAdd.toFixed(0)} mL` : '') + `\nüì¶ Final volume: ${Vtotal.toFixed(1)} L at ${Ct.toFixed(1)}%`;
      } else {
        const shRequired = (targetMix / shStrength) * tankSize;
        const waterRequired = tankSize - shRequired;
        const surfactantRequired = tankSize * surfRatio * 1000;
        const scentRequired = tankSize * scentRatio * 1000;

        lastResult = `üß™ Full Batch:\n‚Ä¢ SH (from ${shStrength}% drum): ${shRequired.toFixed(2)} L\n‚Ä¢ Water: ${waterRequired.toFixed(2)} L\n‚Ä¢ Surfactant: ${surfactantRequired.toFixed(0)} mL` + (scentRatio > 0 ? `\n‚Ä¢ Scent: ${scentRequired.toFixed(0)} mL` : '');
      }

      resultDiv.innerText = lastResult;

      // Show Save to Log button
      saveLogBtn.style.display = 'block';
    }

    function saveCostToLog() {
      if (!lastResult) return;
      const name = prompt("Enter client name (optional):") || "[No Name]";
      const address = prompt("Enter address (optional):") || "[No Address]";
      const cost = document.getElementById('costResult').innerText;
      const timestamp = new Date().toLocaleString();
      const logEntry = `[${timestamp}]\nClient: ${name}\nAddress: ${address}\nCost: ${cost}\n${lastResult}`;
      
      const logs = JSON.parse(localStorage.getItem('softwashLogs') || '[]');
      logs.unshift(logEntry);
      localStorage.setItem('softwashLogs', JSON.stringify(logs));
      alert("Cost saved to log");
    }

    function displayLog() {
      const logs = JSON.parse(localStorage.getItem('softwashLogs') || '[]');
      document.getElementById('logOutput').innerText = logs.join('\n\n');
    }

    function clearLog() {
      if (confirm("Clear all logs?")) {
        localStorage.removeItem('softwashLogs');
        displayLog();
      }
    }
  </script>
</body>
</html>
